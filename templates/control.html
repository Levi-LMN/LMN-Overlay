{% extends "base.html" %}

{% block title %}Stream Control - {{ company_name }}{% endblock %}

{% block extra_css %}
<style>
    .category-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .category-card.active {
        border-color: #4F46E5;
        background: linear-gradient(to bottom, #EEF2FF, #FFFFFF);
    }
    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: #CBD5E1;
        border-radius: 30px;
        cursor: pointer;
        transition: 0.3s;
        flex-shrink: 0;
    }
    .toggle-switch.active {
        background: #10B981;
    }
    .toggle-switch::before {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        top: 3px;
        left: 3px;
        transition: 0.3s;
    }
    .toggle-switch.active::before {
        left: 33px;
    }
    .quick-action {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    .quick-action:hover {
        background: #F9FAFB;
        border-color: #4F46E5;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 640px) {
        .toggle-switch {
            width: 50px;
            height: 26px;
        }
        .toggle-switch::before {
            width: 20px;
            height: 20px;
        }
        .toggle-switch.active::before {
            left: 27px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2 flex items-center">
            <i class="fas fa-broadcast-tower text-indigo-600 mr-2 sm:mr-3 text-xl sm:text-2xl"></i>
            <span>Stream Control Panel</span>
        </h1>
        <p class="text-sm sm:text-base text-gray-600">Quick controls for your live streaming overlays</p>
    </div>

    <!-- Category Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        {% for category in categories %}
        {% set s = settings[category] %}
        <div class="category-card bg-white rounded-lg shadow-md p-4 sm:p-6 {% if s.is_visible %}active{% endif %}"
             data-category="{{ category }}">
            <!-- Header with Toggle -->
            <div class="flex items-start justify-between mb-4 gap-3">
                <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas {% if category == 'funeral' %}fa-dove{% elif category == 'wedding' %}fa-heart{% else %}fa-trophy{% endif %} text-indigo-600 text-lg sm:text-xl"></i>
                    </div>
                    <div class="min-w-0">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-900 capitalize truncate">{{ category }}</h3>
                        <span class="text-xs sm:text-sm {% if s.is_visible %}text-green-600{% else %}text-gray-400{% endif %}">
                            {% if s.is_visible %}Live{% else %}Hidden{% endif %}
                        </span>
                    </div>
                </div>
                <div class="toggle-switch {% if s.is_visible %}active{% endif %}"
                     data-category="{{ category }}"
                     onclick="toggleVisibility('{{ category }}', this)">
                </div>
            </div>

            <!-- Main Text Quick Edit -->
            <div class="mb-3">
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Main Text</label>
                <input type="text"
                       id="{{ category }}_main_text"
                       value="{{ s.main_text or '' }}"
                       class="w-full px-2 sm:px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       onchange="updateText('{{ category }}', 'main_text', this.value)">
            </div>

            <!-- Secondary Text Quick Edit -->
            <div class="mb-4">
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Secondary Text</label>
                <input type="text"
                       id="{{ category }}_secondary_text"
                       value="{{ s.secondary_text or '' }}"
                       class="w-full px-2 sm:px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       onchange="updateText('{{ category }}', 'secondary_text', this.value)">
            </div>

            <!-- Quick Actions -->
            <div class="flex gap-2 flex-wrap">
                <a href="{{ url_for('main.customize', category=category) }}"
                   class="quick-action flex-1 justify-center min-w-[120px]">
                    <i class="fas fa-sliders-h text-indigo-600"></i>
                    <span class="text-xs sm:text-sm font-medium">Customize</span>
                </a>
                <a href="{{ url_for('main.display', category=category) }}"
                   target="_blank"
                   class="quick-action flex-1 justify-center min-w-[120px]">
                    <i class="fas fa-external-link-alt text-gray-600"></i>
                    <span class="text-xs sm:text-sm font-medium">Preview</span>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-bolt text-yellow-500 mr-2"></i>
            <span>Quick Actions</span>
        </h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
            <button onclick="hideAllOverlays()"
                    class="quick-action justify-center py-2 sm:py-3 hover:bg-red-50 hover:border-red-300 flex-col sm:flex-row gap-1 sm:gap-2">
                <i class="fas fa-eye-slash text-red-600 text-lg sm:text-base"></i>
                <span class="text-xs sm:text-sm font-medium text-red-700">Hide All</span>
            </button>
            <button onclick="resetAllTexts()"
                    class="quick-action justify-center py-2 sm:py-3 hover:bg-blue-50 hover:border-blue-300 flex-col sm:flex-row gap-1 sm:gap-2">
                <i class="fas fa-undo text-blue-600 text-lg sm:text-base"></i>
                <span class="text-xs sm:text-sm font-medium text-blue-700">Reset Texts</span>
            </button>
            <a href="{{ url_for('ocr.index') }}"
               class="quick-action justify-center py-2 sm:py-3 hover:bg-purple-50 hover:border-purple-300 flex-col sm:flex-row gap-1 sm:gap-2">
                <i class="fas fa-file-text text-purple-600 text-lg sm:text-base"></i>
                <span class="text-xs sm:text-sm font-medium text-purple-700">OCR Tools</span>
            </a>
            <button onclick="refreshAllPreviews()"
                    class="quick-action justify-center py-2 sm:py-3 hover:bg-green-50 hover:border-green-300 flex-col sm:flex-row gap-1 sm:gap-2">
                <i class="fas fa-sync-alt text-green-600 text-lg sm:text-base"></i>
                <span class="text-xs sm:text-sm font-medium text-green-700">Refresh All</span>
            </button>
        </div>
    </div>
</div>

<script>
    function toggleVisibility(category, element) {
        const isActive = element.classList.contains('active');
        const newState = !isActive;

        fetch(`/api/visibility/${category}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({visible: newState})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                element.classList.toggle('active');
                const card = element.closest('.category-card');
                card.classList.toggle('active');

                // Update status text
                const statusText = card.querySelector('span.text-xs, span.text-sm');
                if (newState) {
                    statusText.textContent = 'Live';
                    statusText.className = statusText.className.replace('text-gray-400', 'text-green-600');
                } else {
                    statusText.textContent = 'Hidden';
                    statusText.className = statusText.className.replace('text-green-600', 'text-gray-400');
                }

                showToast(newState ? 'Overlay activated' : 'Overlay hidden', 'success');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to update visibility', 'error');
        });
    }

    function updateText(category, field, value) {
        const formData = new FormData();
        formData.append(field, value);

        fetch(`/api/settings/${category}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Text updated', 'success');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to update text', 'error');
        });
    }

    function hideAllOverlays() {
        const categories = {{ categories|tojson }};
        let promises = categories.map(cat =>
            fetch(`/api/visibility/${cat}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({visible: false})
            })
        );

        Promise.all(promises)
            .then(() => {
                location.reload();
                showToast('All overlays hidden', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to hide overlays', 'error');
            });
    }

    function resetAllTexts() {
        if (!confirm('Reset all text fields to defaults?')) return;

        const categories = {{ categories|tojson }};
        let promises = categories.map(cat =>
            fetch(`/api/settings/${cat}/reset`, {
                method: 'POST'
            })
        );

        Promise.all(promises)
            .then(() => {
                location.reload();
                showToast('All texts reset', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to reset texts', 'error');
            });
    }

    function refreshAllPreviews() {
        showToast('All preview windows should refresh automatically', 'info');
    }

    function showToast(message, type) {
        const container = document.getElementById('flash-container');
        const colorMap = {
            'success': 'bg-green-500',
            'error': 'bg-red-500',
            'info': 'bg-blue-500'
        };

        const toast = document.createElement('div');
        toast.className = `toast px-4 sm:px-6 py-3 sm:py-4 rounded-lg shadow-lg w-full sm:max-w-md ${colorMap[type]} text-white`;
        toast.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center flex-1 mr-2">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle mr-2 sm:mr-3 flex-shrink-0"></i>
                    <span class="text-sm sm:text-base">${message}</span>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}