<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funeral Overlay - Minimal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
            font-family: 'Courier New', monospace;
        }
        .fade-in { animation: fadeIn 2s ease-in; }
        .slide-left { animation: slideLeft 1s ease-out; }
        .slide-right { animation: slideRight 1s ease-out; }
        .slide-up { animation: slideUp 1s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .ticker { animation: scroll 30s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="w-screen h-screen">
    <div id="overlay-container" class="w-full h-full relative">
        <div id="logo" class="absolute top-8 right-8 hidden" style="z-index: 50;">
            <img src="{{ url_for('static', filename=overlay['logo_path']) if overlay['logo_path'] else '' }}"
                 alt="Logo" class="h-16 w-auto opacity-70">
        </div>

        <div id="event_info" class="absolute top-12 left-8 hidden" style="z-index: 50;">
            <div id="event-card" class="bg-white/95 px-6 py-4 max-w-sm">
                <div id="deceased-name" class="text-black text-2xl font-bold mb-1"></div>
                <div id="dates" class="text-gray-700 text-sm"></div>
            </div>
        </div>

        <div id="speaker" class="absolute bottom-12 left-8 hidden" style="z-index: 50;">
            <div id="speaker-card" class="bg-black/90 px-5 py-3">
                <div id="speaker-name" class="text-white text-lg font-bold"></div>
                <div id="speaker-title" class="text-gray-300 text-xs"></div>
            </div>
        </div>

        <div id="ticker" class="absolute bottom-0 w-full hidden" style="z-index: 50;">
            <div id="ticker-bg" class="py-2 px-4 bg-white/90">
                <div class="ticker whitespace-nowrap">
                    <span id="ticker-text" class="text-black text-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const overlayId = '{{ overlay_id }}';
        let currentData = {};

        socket.on('connect', () => {
            socket.emit('join', {overlay_id: overlayId});
            loadInitialData();
        });

        socket.on('overlay_update', (data) => {
            updateOverlay(data);
        });

        async function loadInitialData() {
            try {
                const response = await fetch(`/api/overlay/${overlayId}`);
                const data = await response.json();
                updateOverlay(data);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateOverlay(data) {
            currentData = {...currentData, ...data};

            toggleElement('logo', currentData.show_logo === 'true');
            toggleElement('speaker', currentData.show_speaker === 'true');
            toggleElement('event_info', currentData.show_event_info === 'true');
            toggleElement('ticker', currentData.show_ticker === 'true');

            if (currentData.deceased_name) {
                document.getElementById('deceased-name').textContent = currentData.deceased_name;
            }
            if (currentData.birth_date && currentData.death_date) {
                document.getElementById('dates').textContent =
                    `${currentData.birth_date} - ${currentData.death_date}`;
            }
            if (currentData.speaker_name) {
                document.getElementById('speaker-name').textContent = currentData.speaker_name;
            }
            if (currentData.speaker_title) {
                document.getElementById('speaker-title').textContent = currentData.speaker_title;
            }
            if (currentData.ticker_text) {
                document.getElementById('ticker-text').textContent = currentData.ticker_text;
            }

            if (currentData.primary_color) {
                document.getElementById('event-card').style.background = currentData.primary_color;
            }
            if (currentData.text_color) {
                const texts = document.querySelectorAll('#deceased-name, #speaker-name');
                texts.forEach(text => {
                    text.style.color = currentData.text_color;
                });
            }
            if (currentData.animation) {
                applyAnimation(currentData.animation);
            }
        }

        function toggleElement(id, show) {
            const element = document.getElementById(id);
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        function applyAnimation(animation) {
            if (animation !== 'none') {
                const elements = document.querySelectorAll('#event-card, #speaker-card');
                elements.forEach(el => {
                    el.classList.remove('fade-in', 'slide-left', 'slide-right', 'slide-up');
                    void el.offsetWidth;
                    el.classList.add(animation);
                });
            }
        }
    </script>
</body>
</html>